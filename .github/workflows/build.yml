name: "Build kernels"
on:
  workflow_dispatch:
    inputs:
      BR:
        description: 'kernel Branch'
        required: true
        default: 'KSUN'
        type: choice
        options:
        - KSUN
        - stable
        - test
      TREE:
        description: 'Kernel Tree'
        required: true
        default: 'https://github.com/UdyneO2/kernel_realme_RMX2195'
      AK3:
        description: 'Anykernel Tree'
        required: true
        default: 'https://github.com/UdyneO2/Anykernel3'
      clang_src :
        description: 'clang compiler'
        required: true
        default: 'https://github.com/techyminati/android_prebuilts_clang_host_linux-x86_clang-6443078'
      AK3_BR:
        description: 'AK3 Branch'
        required: true
        default: 'RMX2195'
      NAME:
        description: 'Specify your kernel NAME.'
        required: true
        default: 'RMX2195'
      DEVICE:
        description: 'Specify your Device Codename.'
        required: true
        default: 'RMX2195'
      KSU:
        description: 'kernel Branch'
        required: true
        default: 'true'
        type: choice
        options:
        - true
        - false
jobs:
  Build-Kernel:
    name: "🐎 Build kernel"
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2
      fail-fast: false
    env:
      kernelDir: dir_${{ inputs.NAME}}
      kernelName: ${{ inputs.NAME}
      kernelRepo: ${{ inputs.TREE }}
      kernelBranch: ${{ inputs.BR }}
      kernelDevice: ${{ inputs.DEVICE }}
      ANYKERNEL_NAME: Anykernel3
      ANYKERNEL_SOURCE: ${{ inputs.AK3 }}
      ANYKERNEL_SOURCE_BRANCH: ${{ = }}
      DEFCONFIG_NAME: vendor/${{ inputs.DEVICE }}_defconfig
      withKSUN: ${{ inputs.KSU }}
      ARCH: arm64
      temp: ${{ env.kernelName }}/out
      ROOT: ~/
      
    steps:
      - name: "✨ Create working dir"
        run: mkdir -p $kernelDir

      - name: "⭐ Install prerequisites"
        run: |
          sudo apt-get update
          sudo apt update && sudo apt install bc  bison  build-essential  ccache   curl  flex  git libelf-dev libssl-dev lzop  python3  rsync unzip  zlib1g-dev gcc gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi make libncurses5-dev libncursesw5-dev wget
      - name: "🌟 Clone kernel source => (${{ env.kernelRepo }})"
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --recursive --branch $kernelBranch $kernelRepo $kernelName --depth=1
          
      - name: "😋 Update KernelSU-Next"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        if: ${{ env.withKSUN == 'true' }}
        run: |
          cat ./arch/arm64/configs/${{ env.DEFCONFIG_NAME }} | grep KSU

      - name: "🎶 Build kernel"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          export KBUILD_BUILD_USER="mnrdnn"
          export KBUILD_BUILD_HOST="github"
          git clone $clang_src ~/toolchains/clang --depth=1 
          export CLANG_PATH=~/toolchains/clang/bin
          export PATH=${CLANG_PATH}:${PATH}
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          echo "PATH Variable: $PATH"
          echo
          echo "Set DEFCONFIG"
          echo 
          make CC=clang AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip O=out ${{ env.DEFCONFIG_NAME }}
          echo
          echo "Set DEFCONFIG"
          echo 
          make CC=clang AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip O=out -j$(nproc --all)
          echo
          echo "Build Succesfully"

      - name: "📦 Package kernel with AnyKernel3"
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --depth=1 $ANYKERNEL_SOURCE -b $ANYKERNEL_SOURCE_BRANCH $ANYKERNEL_NAME && rm -rf $ANYKERNEL_NAME/.git $ANYKERNEL_NAME/.github $ANYKERNEL_NAME/LICENSE $ANYKERNEL_NAME/README.md
          if [[ -f $temp/arch/$ARCH/boot/Image.gz ]]; then
            cp $temp/arch/$ARCH/boot/Image.gz $ANYKERNEL_NAME/Image.gz
            echo -e "Image.gz found"
          else
            echo -e "Image.gz not found"
            echo -e "Do find"
            find . -type f 2>/dev/null | grep "Image.gz"
          fi
          if [[ -f $temp/arch/$ARCH/boot/Image ]]; then
            cp $temp/arch/$ARCH/boot/Image $ANYKERNEL_NAME/Image
          fi
          cd $ANYKERNEL_NAME && zip -r9 Release-${{ env.kernelName }}-${{ inputs.DEVICE }}.zip *
      
          mv Release-${{ env.kernelName }}-${{ inputs.DEVICE }}.zip ../{{ env.kernelName }}-${{ inputs.DEVICE }}.zip
          echo ""
          echo -e "Upload Anykernel3.zip"
          echo ""
          ls $ANYKERNEL_NAME
      - uses: softprops/action-gh-release@v2
        with:
         token: ${{ secrets.GH_TOKEN }}
         repository: UdyneO2/kernel_realme_RMX2195
         files: |
           ../Release-${{ env.kernelName }}-${{ inputs.DEVICE }}.zip
         name: Update Kernel Build | ${{ env.ANYKERNEL_NAME }}-${{ inputs.DEVICE }}
         tag_name: ${{ env.kernel }}/
         body: |
          ### Release Notes:
          * Kernel compiled using clang 11.0.1
          * flash at your own risk.
          * Thanks [github](https://github.com)
          * Use [branch](https://github.com/UdyneO2/kernel_realme_RMX2195/tree/KSUN)
          
           ### Changelog ;
          * - Add KernelSU-Next v1.0.8 Support
          * - Add Susfs 1.5.8 support : Thanks to [sidex15](https://t.me/sidex15) - [Kernel Source](https://github.com/sidex15/kernel_realme_sm4250)
          * - Enable uclamp
          * - Add more gpucc-size
          * - bugs? tell [me](https://t.me/mnrdnn)
      - uses: actions/upload-artifact@v4
        with:
          name: Release-${{ env.kernelName }}-${{ inputs.DEVICE }}
          path: ./$ANYKERNEL_NAME/*

